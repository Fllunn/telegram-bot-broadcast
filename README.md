# Telegram Broadcast Bot

> Производственный Telegram‑бот для рассылок на базе [Telethon](https://github.com/LonamiWebs/Telethon) и MongoDB. Поддерживает несколько пользовательских аккаунтов, ручные и автоматические рассылки, загрузку списков групп из Excel и удобный интерфейс оператора на русском языке.

## Содержание
- [Обзор](#обзор)
- [Возможности](#возможности)
- [Архитектура](#архитектура)
- [Требования](#требования)
- [Установка и запуск](#установка-и-запуск)
- [Конфигурация (.env)](#конфигурация-env)
- [Настройка базы данных](#настройка-базы-данных)
- [Быстрый старт](#быстрый-старт)
- [Использование](#использование)

## Обзор
Этот проект — операторский Telegram‑бот, который позволяет:
- авторизовать несколько пользовательских аккаунтов Telegram (через SMS или QR‑код),
- загрузить списки групп/каналов из Excel,
- подготовить текст/картинку для рассылки,
- запустить ручную рассылку или настроить периодическую авторассылку.

Все состояния и данные (пользователи, Telethon‑сессии, автозадачи) хранятся в MongoDB. Бот безопасно раскладывает отправки по времени, показывает прогресс и умеет останавливать рассылку.

## Возможности
- **Мультиаккаунт**: подключение аккаунтов по телефону/коду или по QR, проверка «здоровья» и безопасная деактивация.
- **Ручные рассылки**: текст/картинка на аккаунт, отправка по уникальным группам, прогресс и отмена, аккуратные задержки.
- **Авторассылки**: интервал с джиттером, блокировки по задаче, пауза/возобновление/остановка, уведомления по циклам.
- **Списки групп**: загрузка `.xlsx`/`.xls` или ссылка на Google Таблицу (просмотр по ссылке), нормализация ссылок/юзернеймов, дедупликация по chat id/username/link, статистика.
 - **Списки групп**: загрузка `.xlsx`/`.xls` или ссылка на Google Таблицу (просмотр по ссылке), авто‑мониторинг изменений таблицы каждые 10 минут, нормализация ссылок/юзернеймов, дедупликация по chat id/username/link, статистика.
- **Интерфейс на русском**: все команды, подсказки и сообщения бота — на русском.
- **Наблюдаемость**: структурированное логирование, кеш «здоровья» аккаунтов, индексы Mongo.

## Архитектура
```
src/
├── app.py                   # Сборка зависимостей и жизненный цикл приложения
├── main.py                  # Точка входа (python -m src)
├── bot/                     # Команды Telethon и клавиатуры
│   ├── application.py       # Запуск бота (клиент + контекст)
│   ├── commands/            # /start, /broadcast, /auto_schedule, и т.д.
│   ├── context.py           # Контекст: репозитории/сервисы для команд
│   └── keyboards.py         # Reply/inline‑клавиатуры (русские подписи)
├── config/                  # Настройки и параметры таймингов
│   ├── settings.py          # Pydantic‑настройки из .env
│   └── broadcast_settings.py# Константы задержек/батчей для ручных рассылок
├── db/                      # Mongo‑клиент и репозитории
│   ├── client.py            # AsyncIOMotor‑подключение
│   └── repositories/        # users, sessions, auto tasks, accounts
├── models/                  # Pydantic‑модели (users, sessions, tasks)
├── services/                # Бизнес‑логика (статусы, авто‑движок, утилиты)
│   ├── telethon_manager.py  # Жизненный цикл Telethon‑сессий
│   ├── account_status.py    # Проверка «здоровья» аккаунтов + кеш
│   ├── broadcast_state.py   # FSM для ручных рассылок
│   ├── groups_state.py      # FSM для загрузки/просмотра групп
│   └── auto_broadcast/      # Планировщик, раннер, полезные функции
└── utils/logging.py         # Логирование (dictConfig)
```
Коллекции MongoDB по умолчанию: `users`, `telethon_sessions`, `auto_broadcast_tasks`, `auto_accounts`.

## Требования
- **Python ≥ 3.10** (рекомендуется 3.11)
- **MongoDB 5.x+** (локально или облачно)
- **TELEGRAM_API_ID / TELEGRAM_API_HASH** (my.telegram.org) и **TELEGRAM_BOT_TOKEN** (BotFather)
- Linux: устанавливайте заголовки `libffi`/`libssl` через пакетный менеджер

## Установка и запуск

### Windows (Git Bash)
```bash
# 1) Клонируйте проект
git clone https://github.com/Fllunn/telegram-bot-broadcast.git
cd telegram-bot-broadcast

# 2) Создайте и активируйте виртуальное окружение
python -m venv .venv
source .venv/Scripts/activate

# 3) Обновите pip и установите зависимости
python -m pip install --upgrade pip
python -m pip install -r requirements.txt

# 4) Скопируйте шаблон окружения и заполните переменные
cp .env.example .env
# Укажите TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_BOT_TOKEN, MONGO_DSN, MONGO_DATABASE

# 5) Убедитесь, что MongoDB доступен (например, mongodb://localhost:27017)

# 6) Запустите бота
python -m src
```

#### Тесты (опционально)
```bash
python -m pip install pytest
pytest -q
```
Подсказки:
- PowerShell: `./.venv/Scripts/Activate.ps1`, CMD: `./.venv/Scripts/activate.bat`
- Для корректного отображения кириллицы в CMD можно выполнить `chcp 65001`

### Linux/macOS
```bash
git clone https://github.com/Fllunn/telegram-bot-broadcast.git
cd telegram-bot-broadcast

python -m venv .venv
source .venv/bin/activate

python -m pip install --upgrade pip
python -m pip install -r requirements.txt

cp .env.example .env
# Заполните TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_BOT_TOKEN, MONGO_DSN, MONGO_DATABASE

python -m src
```

### Быстрая проверка окружения (опционально)
```bash
# Проверить версии библиотек
python - << 'PY'
import telethon, motor
print("Telethon:", telethon.__version__)
print("Motor:", motor.__version__)
PY

# Проверить подключение к MongoDB
python - << 'PY'
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
async def main():
      client = AsyncIOMotorClient("mongodb://localhost:27017")
      dbs = await client.list_database_names()
      print("Mongo OK, databases:", dbs[:5])
asyncio.run(main())
PY
```

## Конфигурация (.env)
Переменные окружения читаются через `pydantic-settings` из файла `.env`.

| Переменная | Обязательна | Значение по умолчанию | Назначение |
|------------|-------------|------------------------|------------|
| `TELEGRAM_API_ID` | да | – | API ID для Telethon‑клиентов |
| `TELEGRAM_API_HASH` | да | – | API Hash для Telethon |
| `TELEGRAM_BOT_TOKEN` | да | – | Токен бота от BotFather |
| `MONGO_DSN` | да | – | Строка подключения к MongoDB |
| `MONGO_DATABASE` | да | – | Имя базы данных |
| `APP_NAME` | нет | `telegram-broadcast-bot` | Имя приложения (в логах/драйвере) |
| `BOT_SESSION_NAME` | нет | `bot_session` | Имя файла сессии бота (`bot_session.session`) |
| `USER_COLLECTION` | нет | `users` | Коллекция пользователей бота |
| `SESSION_COLLECTION` | нет | `telethon_sessions` | Коллекция Telethon‑сессий |
| `AUTO_TASK_COLLECTION` | нет | `auto_broadcast_tasks` | Коллекция автозадач |
| `AUTO_ACCOUNT_COLLECTION` | нет | `auto_accounts` | Коллекция статусов аккаунтов |
| `AUTO_TASK_POLL_INTERVAL` | нет | `15` | Интервал опроса автозадач (сек.) |
| `AUTO_TASK_LOCK_TTL` | нет | `180` | TTL блокировки автозадач (сек.) |
| `LOG_LEVEL` | нет | `INFO` | Уровень логирования |
| `ACCOUNT_STATUS_CONCURRENCY` | нет | `10` | Параллелизм проверки аккаунтов |
| `ACCOUNT_STATUS_TIMEOUT_SECONDS` | нет | `2.0` | Таймаут проверки одного аккаунта |
| `ACCOUNT_STATUS_CACHE_TTL_SECONDS` | нет | `20.0` | TTL кеша статусов |
| `ACCOUNT_STATUS_DB_REFRESH_SECONDS` | нет | `180.0` | Период обновления из БД |
| `GOOGLE_SERVICE_ACCOUNT_JSON` | нет | – | Путь к JSON сервис‑аккаунта Google (для чтения приватных таблиц; иначе требуется «Просмотр по ссылке») |

Минимальный пример `.env`:
```dotenv
TELEGRAM_API_ID=123456
TELEGRAM_API_HASH=<ваш_api_hash>
TELEGRAM_BOT_TOKEN=<токен_бота_из_BotFather>
MONGO_DSN=mongodb://localhost:27017
MONGO_DATABASE=telegram_bot
```

> Не храните секреты в репозитории. Перед деплоем используйте защищённые секреты среды.

## Настройка базы данных
Миграции не требуются — индексы создаются при запуске.

| Коллекция | Индексы | Назначение |
|-----------|---------|------------|
| `users` | `telegram_id` (уникальный) | Операторы, общающиеся с ботом |
| `telethon_sessions` | `session_id` (уник.), `(owner_id, owner_type)` | Сессии Telethon, материалы рассылок, списки групп, статусы |
| `auto_broadcast_tasks` | `task_id` (уник.), `(user_id, status)`, `next_run_ts`, `enabled`, `locked_by` | Авторассылки: планирование, блокировки и статистика |
| `auto_accounts` | `account_id` (уник.), `(owner_id, status)`, `cooldown_until` | Состояние аккаунтов для авторассылок |

Убедитесь, что пользователь Mongo имеет права на чтение/запись указанной базы. Для продакшна — включайте аутентификацию, TLS и бэкапы.

## Быстрый старт
1. Активируйте виртуальное окружение.
2. Заполните `.env` корректными значениями Telegram и Mongo.
3. Запустите бота:
    ```bash
    python -m src
    ```
4. В Telegram отправьте `/start`, чтобы открыть меню и зарегистрироваться как оператор.

> Файл сессии бота `bot_session.session` храните рядом с `.env` на хосте.

## Использование

### Краткая справка по командам
| Назначение | Команда/кнопка |
|------------|----------------|
| Главное меню | `/start` |
| Вход по телефону (SMS) | `/login_phone` |
| Вход по QR‑коду | `/login_qr` |
| Список/отвязка аккаунтов | `/accounts` |
| Добавить/заменить текст | `/add_text` |
| Добавить/заменить картинку | `/add_image` |
| Загрузить списки групп | `/upload_groups` |
| Посмотреть сохранённые группы | `/view_groups` |
| Просмотр материалов | `/view_broadcast` |
| Запуск ручной рассылки | `/broadcast` |
| Настройка авторассылки | кнопка «Авторассылка» или `/auto_schedule` |
| Статус авторассылки | кнопка «Статус авторассылки» или `/auto_status` |



### Загрузка списков групп
- Отправьте Excel‑файл: форматы `.xlsx`, `.xls` (используется первый лист), либо пришлите ссылку на Google Таблицу.
- Для Google Sheets ссылка должна быть «по ссылке: просмотр». Из ссылки извлекаются `spreadsheetId` и `gid`, данные читаются через публичный CSV‑экспорт.
- Если таблица приватная, можно настроить переменную окружения `GOOGLE_SERVICE_ACCOUNT_JSON` и выдать этому сервис‑аккаунту «Чтение» — тогда бот сможет читать и приватные таблицы.
- Колонки (A:C, регистр не важен): `Название`, `Username`, `Ссылка` (лишние игнорируются; первая строка может быть заголовком).
- Ссылки нормализуются к `https://t.me/...`, `@` у username удаляется, дубли удаляются по chat id/username/link.
- Пустые строки игнорируются. Если таблица/файл пустые — бот сообщит об этом.
- Типичные ошибки и сообщения:
    - «Некорректная ссылка, пришлите правильную ссылку на Google Таблицу.» — ссылка сломана или неверный формат.
    - «Не удалось открыть таблицу: по ссылке нет доступа на просмотр. Откройте возможность просмотра по ссылке и отправьте ещё раз.» — у ссылки закрыт доступ; включите «Просмотр по ссылке» или дайте доступ сервис‑аккаунту.
    - «Таблица пустая.» — нет данных в первых трёх столбцах.

#### Как быстро протестировать на реальной таблице
1) Создайте Google Таблицу с тремя колонками: `Название`, `Username`, `Ссылка`. Заполните несколько строк.
2) Включите «Доступ по ссылке: Просмотр» и скопируйте URL (в нём должен быть параметр `gid`).
3) В Telegram, в шаге загрузки групп, просто вставьте ссылку вместо файла.
4) Если таблица приватная и нельзя открыть «по ссылке», создайте сервис‑аккаунт в Google Cloud, скачайте JSON и укажите путь в `GOOGLE_SERVICE_ACCOUNT_JSON`. Выдайте этому аккаунту доступ «Просмотр» к таблице.

### Автоматический мониторинг Google Таблиц
После первой загрузки списка групп по ссылке Google Sheets бот сохраняет ссылку и хеш содержимого в коллекции `group_sheet_links`. Фоновая задача каждые ~10 минут:
1. Скачивает CSV из каждой сохранённой таблицы.
2. Сравнивает хеш нормализованных строк (название|username|link).
3. При изменениях пересобирает список групп (валидирует, дедуплицирует) и обновляет соответствующий аккаунт.
4. Отправляет оператору сообщение: «Список групп обновлён: обнаружены изменения в таблице».
5. Если таблица недоступна (403/404/ошибка сети) — сообщение: «Не удалось подключиться к таблице — проверьте ссылку и права доступа».

Хранилище состояния (`group_sheet_links`):
```
session_id, owner_id, url, spreadsheet_id, gid,
content_hash, last_sync_ts, last_error, last_error_ts, created_at, updated_at
```

При перезапуске бот считывает коллекцию и продолжает проверки без потери истории.

### Управление аккаунтами
- `/login_phone` — вход по телефону/коду и, при необходимости, 2FA‑паролю
- `/login_qr` — вход по QR с кнопкой «Обновить QR» и защитой от повторного подключения текущего аккаунта
- `/accounts` — актуальные статусы, фоновое обновление, кнопки «Отвязать»
- При потере доступа в процессе отправки бот деактивирует аккаунт и просит авторизоваться заново